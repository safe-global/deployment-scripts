name: Deploy All Contracts

on:
  workflow_dispatch:
    inputs:
      custom_rpc_url:
        description: 'Custom RPC URL for the network'
        required: true
        type: string
      block_explorer_url:
        description: 'Block explorer URL (optional)'
        required: false
        type: string
      network_name:
        description: 'Network name (for logging purposes)'
        required: false
        type: string
        default: 'custom'
      deploy_targets:
        description: 'Comma-separated list of targets to deploy (e.g., "1.5.0,modules,erc20,erc721" or "all"). Options: 1.3.0, 1.3.0-155, 1.4.1, 1.5.0, modules, erc20, erc721, all'
        required: false
        type: string
        default: ''
      erc20_mint_amount:
        description: 'Amount of ERC20 tokens to mint (default: 1000)'
        required: false
        type: string
        default: '1000'
      erc721_token_id:
        description: 'Token ID for ERC721 NFT (default: 1)'
        required: false
        type: string
        default: '1'

# Prevent concurrent deployments to the same network
concurrency:
  group: deploy-${{ github.event.inputs.network_name || 'custom' }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy All Contracts
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      CUSTOM_RPC_URL: ${{ github.event.inputs.custom_rpc_url }}
      BLOCK_EXPLORER_URL: ${{ github.event.inputs.block_explorer_url }}
      NETWORK: ${{ github.event.inputs.network_name }}
      CI: true
      GITHUB_ACTIONS: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate required secrets and inputs
        run: |
          if [ -z "$PRIVATE_KEY" ]; then
            echo "::error::PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$CUSTOM_RPC_URL" ]; then
            echo "::error::CUSTOM_RPC_URL is required"
            exit 1
          fi
          # Mask the full RPC URL to prevent API key leaks in logs
          echo "::add-mask::$CUSTOM_RPC_URL"
          RPC_MASKED=$(echo "$CUSTOM_RPC_URL" | sed -E 's|(https?://[^/?#]+).*|\1/***|')
          echo "::notice::Network: ${NETWORK:-custom}"
          echo "::notice::RPC URL: $RPC_MASKED"

      - name: Parse and validate deployment targets
        id: parse_targets
        run: |
          DEPLOY_TARGETS="${{ github.event.inputs.deploy_targets }}"
          
          # Normalize input: lowercase, remove spaces
          DEPLOY_TARGETS=$(echo "$DEPLOY_TARGETS" | tr '[:upper:]' '[:lower:]' | tr -d ' ')
          
          # If empty, exit gracefully
          if [ -z "$DEPLOY_TARGETS" ] || [ "$DEPLOY_TARGETS" = "" ]; then
            echo "::notice::No deployment targets specified, skipping all deployments"
            echo "deploy_1_3_0=false" >> $GITHUB_OUTPUT
            echo "deploy_1_3_0_155=false" >> $GITHUB_OUTPUT
            echo "deploy_1_4_1=false" >> $GITHUB_OUTPUT
            echo "deploy_1_5_0=false" >> $GITHUB_OUTPUT
            echo "deploy_modules=false" >> $GITHUB_OUTPUT
            echo "deploy_erc20=false" >> $GITHUB_OUTPUT
            echo "deploy_erc721=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Valid target names
          VALID_TARGETS=("1.3.0" "1.3.0-155" "1.4.1" "1.5.0" "modules" "erc20" "erc721" "all")
          
          # Check for "all" keyword
          if echo "$DEPLOY_TARGETS" | grep -qE "^all$|^all,|,all$|,all,"; then
            if [ "$DEPLOY_TARGETS" != "all" ]; then
              echo "::error::Invalid deploy_targets: 'all' cannot be combined with other targets"
              exit 1
            fi
            echo "::notice::Deploying all targets"
            echo "deploy_1_3_0=true" >> $GITHUB_OUTPUT
            echo "deploy_1_3_0_155=true" >> $GITHUB_OUTPUT
            echo "deploy_1_4_1=true" >> $GITHUB_OUTPUT
            echo "deploy_1_5_0=true" >> $GITHUB_OUTPUT
            echo "deploy_modules=true" >> $GITHUB_OUTPUT
            echo "deploy_erc20=true" >> $GITHUB_OUTPUT
            echo "deploy_erc721=true" >> $GITHUB_OUTPUT
          else
            # Split by comma and validate each target
            IFS=',' read -ra TARGET_ARRAY <<< "$DEPLOY_TARGETS"
            INVALID_TARGETS=()
            
            for target in "${TARGET_ARRAY[@]}"; do
              # Trim whitespace
              target=$(echo "$target" | xargs)
              
              # Check if target is valid
              VALID=false
              for valid_target in "${VALID_TARGETS[@]}"; do
                if [ "$target" = "$valid_target" ]; then
                  VALID=true
                  break
                fi
              done
              
              if [ "$VALID" = false ]; then
                INVALID_TARGETS+=("$target")
              fi
            done
            
            # If any invalid targets found, fail
            if [ ${#INVALID_TARGETS[@]} -gt 0 ]; then
              echo "::error::Invalid deployment targets: ${INVALID_TARGETS[*]}"
              echo "::error::Valid options are: ${VALID_TARGETS[*]}"
              exit 1
            fi
            
            # Set outputs for each target
            echo "$DEPLOY_TARGETS" | grep -qE "^1\.3\.0$|^1\.3\.0,|,1\.3\.0$|,1\.3\.0," && echo "deploy_1_3_0=true" >> $GITHUB_OUTPUT || echo "deploy_1_3_0=false" >> $GITHUB_OUTPUT
            echo "$DEPLOY_TARGETS" | grep -qE "^1\.3\.0-155$|^1\.3\.0-155,|,1\.3\.0-155$|,1\.3\.0-155," && echo "deploy_1_3_0_155=true" >> $GITHUB_OUTPUT || echo "deploy_1_3_0_155=false" >> $GITHUB_OUTPUT
            echo "$DEPLOY_TARGETS" | grep -qE "^1\.4\.1$|^1\.4\.1,|,1\.4\.1$|,1\.4\.1," && echo "deploy_1_4_1=true" >> $GITHUB_OUTPUT || echo "deploy_1_4_1=false" >> $GITHUB_OUTPUT
            echo "$DEPLOY_TARGETS" | grep -qE "^1\.5\.0$|^1\.5\.0,|,1\.5\.0$|,1\.5\.0," && echo "deploy_1_5_0=true" >> $GITHUB_OUTPUT || echo "deploy_1_5_0=false" >> $GITHUB_OUTPUT
            echo "$DEPLOY_TARGETS" | grep -qE "^modules$|^modules,|,modules$|,modules," && echo "deploy_modules=true" >> $GITHUB_OUTPUT || echo "deploy_modules=false" >> $GITHUB_OUTPUT
            echo "$DEPLOY_TARGETS" | grep -qE "^erc20$|^erc20,|,erc20$|,erc20," && echo "deploy_erc20=true" >> $GITHUB_OUTPUT || echo "deploy_erc20=false" >> $GITHUB_OUTPUT
            echo "$DEPLOY_TARGETS" | grep -qE "^erc721$|^erc721,|,erc721$|,erc721," && echo "deploy_erc721=true" >> $GITHUB_OUTPUT || echo "deploy_erc721=false" >> $GITHUB_OUTPUT
            
            # Show what will be deployed
            SELECTED_TARGETS=$(echo "$DEPLOY_TARGETS" | tr ',' ' ')
            echo "::notice::Deploying targets: $SELECTED_TARGETS"
          fi

      - name: Deploy Safe 1.3.0 Canonical
        if: steps.parse_targets.outputs.deploy_1_3_0 == 'true'
        id: deploy_1_3_0
        continue-on-error: true
        run: |
          echo "::notice::Deploying Safe 1.3.0 Canonical contracts..."
          pnpm deploy-1.3.0-canonical --network "${NETWORK:-custom}" || exit 1
          echo "deploy_1_3_0_status=success" >> $GITHUB_OUTPUT

      - name: Deploy Safe 1.3.0 EIP-155
        if: steps.parse_targets.outputs.deploy_1_3_0_155 == 'true'
        id: deploy_1_3_0_155
        continue-on-error: true
        run: |
          echo "::notice::Deploying Safe 1.3.0 EIP-155 contracts..."
          pnpm deploy-1.3.0-155 --network "${NETWORK:-custom}" || exit 1
          echo "deploy_1_3_0_155_status=success" >> $GITHUB_OUTPUT

      - name: Deploy Safe 1.4.1
        if: steps.parse_targets.outputs.deploy_1_4_1 == 'true'
        id: deploy_1_4_1
        continue-on-error: true
        run: |
          echo "::notice::Deploying Safe 1.4.1 contracts..."
          pnpm deploy-1.4.1 --network "${NETWORK:-custom}" || exit 1
          echo "deploy_1_4_1_status=success" >> $GITHUB_OUTPUT

      - name: Deploy Safe 1.5.0
        if: steps.parse_targets.outputs.deploy_1_5_0 == 'true'
        id: deploy_1_5_0
        continue-on-error: true
        run: |
          echo "::notice::Deploying Safe 1.5.0 contracts..."
          pnpm deploy-1.5.0 --network "${NETWORK:-custom}" || exit 1
          echo "deploy_1_5_0_status=success" >> $GITHUB_OUTPUT

      - name: Deploy Safe Modules
        if: steps.parse_targets.outputs.deploy_modules == 'true'
        id: deploy_modules
        continue-on-error: true
        run: |
          echo "::notice::Deploying Safe Modules contracts..."
          pnpm deploy-modules --network "${NETWORK:-custom}" || exit 1
          echo "deploy_modules_status=success" >> $GITHUB_OUTPUT

      - name: Deploy ERC20 Token
        if: steps.parse_targets.outputs.deploy_erc20 == 'true'
        id: deploy_erc20
        continue-on-error: true
        env:
          ERC20_MINT_AMOUNT: ${{ github.event.inputs.erc20_mint_amount }}
        run: |
          echo "::notice::Deploying ERC20 token contract (mint: ${ERC20_MINT_AMOUNT:-1000})..."
          pnpm deploy-erc20 --network "${NETWORK:-custom}" || exit 1
          echo "deploy_erc20_status=success" >> $GITHUB_OUTPUT

      - name: Deploy ERC721 NFT
        if: steps.parse_targets.outputs.deploy_erc721 == 'true'
        id: deploy_erc721
        continue-on-error: true
        env:
          ERC721_TOKEN_ID: ${{ github.event.inputs.erc721_token_id }}
        run: |
          echo "::notice::Deploying ERC721 NFT contract (tokenId: ${ERC721_TOKEN_ID:-1})..."
          pnpm deploy-nft --network "${NETWORK:-custom}" || exit 1
          echo "deploy_erc721_status=success" >> $GITHUB_OUTPUT

      - name: Display deployment summary
        if: always()
        run: |
          echo "## ðŸš€ All Contracts Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Network info
          echo "### Network Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Network** | ${{ github.event.inputs.network_name || 'custom' }} |" >> $GITHUB_STEP_SUMMARY
          
          # Try to get chain ID from any summary file
          CHAIN_ID=""
          if [ -d "deployments" ]; then
            FIRST_SUMMARY=$(find deployments -name "github-actions-summary-*-latest.json" -type f 2>/dev/null | head -1)
            if [ -n "$FIRST_SUMMARY" ] && [ -f "$FIRST_SUMMARY" ] && command -v jq &> /dev/null; then
              CHAIN_ID=$(jq -r '.chainId // ""' "$FIRST_SUMMARY")
              if [ -n "$CHAIN_ID" ] && [ "$CHAIN_ID" != "null" ]; then
                echo "| **Chain ID** | $CHAIN_ID |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          if [ -n "${{ github.event.inputs.block_explorer_url }}" ]; then
            echo "| **Block Explorer** | ${{ github.event.inputs.block_explorer_url }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment targets status
          echo "### Deployment Targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          SKIPPED_COUNT=0
          TOTAL_COUNT=0
          
          declare -A TARGET_STATUS
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_3_0 }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_1_3_0.outcome }}" in
              "success") echo "| Safe 1.3.0 Canonical | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| Safe 1.3.0 Canonical | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| Safe 1.3.0 Canonical | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| Safe 1.3.0 Canonical | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_3_0_155 }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_1_3_0_155.outcome }}" in
              "success") echo "| Safe 1.3.0 EIP-155 | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| Safe 1.3.0 EIP-155 | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| Safe 1.3.0 EIP-155 | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| Safe 1.3.0 EIP-155 | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_4_1 }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_1_4_1.outcome }}" in
              "success") echo "| Safe 1.4.1 | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| Safe 1.4.1 | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| Safe 1.4.1 | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| Safe 1.4.1 | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_5_0 }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_1_5_0.outcome }}" in
              "success") echo "| Safe 1.5.0 | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| Safe 1.5.0 | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| Safe 1.5.0 | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| Safe 1.5.0 | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_modules }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_modules.outcome }}" in
              "success") echo "| Safe Modules | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| Safe Modules | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| Safe Modules | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| Safe Modules | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_erc20 }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_erc20.outcome }}" in
              "success") echo "| ERC20 Token | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| ERC20 Token | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| ERC20 Token | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| ERC20 Token | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_erc721 }}" == "true" ]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            case "${{ steps.deploy_erc721.outcome }}" in
              "success") echo "| ERC721 NFT | âœ… Success |" >> $GITHUB_STEP_SUMMARY; SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
              "failure") echo "| ERC721 NFT | âŒ Failed |" >> $GITHUB_STEP_SUMMARY; FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
              "skipped") echo "| ERC721 NFT | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY; SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
              *) echo "| ERC721 NFT | âš ï¸ Unknown |" >> $GITHUB_STEP_SUMMARY ;;
            esac
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary**: $SUCCESS_COUNT successful, $FAILED_COUNT failed, $SKIPPED_COUNT skipped out of $TOTAL_COUNT targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Detailed contracts table
          if [ -d "deployments" ]; then
            SUMMARY_FILES=$(find deployments -name "github-actions-summary-*-latest.json" -type f 2>/dev/null | sort || true)
            
            if [ -n "$SUMMARY_FILES" ] && command -v jq &> /dev/null; then
              echo "### ðŸ“‹ Deployed Contracts" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Status | Contract | Address | Block |" >> $GITHUB_STEP_SUMMARY
              echo "|:------:|----------|---------|-------|" >> $GITHUB_STEP_SUMMARY
              
              TOTAL_CONTRACTS=0
              SUCCESSFUL_CONTRACTS=0
              
              for SUMMARY_FILE in $SUMMARY_FILES; do
                if [ -f "$SUMMARY_FILE" ]; then
                  # Read all deployments from the file
                  jq -r '.deployments[] | "\(.success)|\(.contractName)|\(.contractAddress // .expectedAddress // "N/A")|\(.blockNumber // "N/A")|\(.txHash // "N/A")"' "$SUMMARY_FILE" 2>/dev/null | while IFS='|' read -r SUCCESS NAME ADDRESS BLOCK TX_HASH; do
                    TOTAL_CONTRACTS=$((TOTAL_CONTRACTS + 1))
                    if [ "$SUCCESS" = "true" ]; then
                      SUCCESSFUL_CONTRACTS=$((SUCCESSFUL_CONTRACTS + 1))
                      STATUS_ICON="âœ…"
                      # Format address as code if valid
                      if [ "$ADDRESS" != "N/A" ] && [ "$ADDRESS" != "null" ] && [ -n "$ADDRESS" ]; then
                        ADDR_DISPLAY="\`$ADDRESS\`"
                      else
                        ADDR_DISPLAY="-"
                      fi
                      # Format block number
                      if [ "$BLOCK" != "N/A" ] && [ "$BLOCK" != "null" ] && [ -n "$BLOCK" ]; then
                        BLOCK_DISPLAY="$BLOCK"
                      else
                        BLOCK_DISPLAY="-"
                      fi
                    else
                      STATUS_ICON="âŒ"
                      ADDR_DISPLAY="-"
                      BLOCK_DISPLAY="-"
                    fi
                    echo "| $STATUS_ICON | **$NAME** | $ADDR_DISPLAY | $BLOCK_DISPLAY |" >> $GITHUB_STEP_SUMMARY
                  done
                fi
              done
              
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ• Deployment completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-results-all
          path: |
            deployments/
          retention-days: 30
          if-no-files-found: warn

      - name: Trigger update-registry for each successful deployment
        if: success() || failure()
        env:
          GITHUB_TOKEN: ${{ secrets.SAFE_DEPLOYMENTS_1_TOKEN }}
        run: |
          # Skip if no token is configured
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "::warning::SAFE_DEPLOYMENTS_1_TOKEN not configured. Skipping registry updates."
            exit 0
          fi
          
          # Get chain ID from deployment summary
          CHAIN_ID=""
          if [ -d "deployments" ]; then
            FIRST_SUMMARY=$(find deployments -name "github-actions-summary-*-latest.json" -type f 2>/dev/null | head -1)
            if [ -n "$FIRST_SUMMARY" ] && [ -f "$FIRST_SUMMARY" ] && command -v jq &> /dev/null; then
              CHAIN_ID=$(jq -r '.chainId // ""' "$FIRST_SUMMARY")
            fi
          fi
          
          if [ -z "$CHAIN_ID" ] || [ "$CHAIN_ID" = "null" ]; then
            echo "::warning::Could not determine chain ID. Skipping registry updates."
            exit 0
          fi
          
          echo "Chain ID: $CHAIN_ID"
          
          REPO="Fbartoli/safe-deployments"
          WORKFLOW_FILE="update-registry.yml"
          
          # Get default branch
          REPO_INFO=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO")
          DEFAULT_BRANCH=$(echo "$REPO_INFO" | jq -r '.default_branch // "main"')
          
          # Get workflow ID
          WORKFLOW_RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE")
          WORKFLOW_ID=$(echo "$WORKFLOW_RESPONSE" | jq -r '.id')
          
          if [ "$WORKFLOW_ID" = "null" ] || [ -z "$WORKFLOW_ID" ]; then
            echo "::error::Could not get workflow ID for $WORKFLOW_FILE"
            exit 1
          fi
          
          trigger_update() {
            local VERSION=$1
            local STEP_OUTCOME=$2
            
            if [ "$STEP_OUTCOME" != "success" ]; then
              echo "â­ï¸ Skipping $VERSION (not successful: $STEP_OUTCOME)"
              return
            fi
            
            echo "ðŸ”„ Triggering update-registry for $VERSION..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/dispatches" \
              -d "{
                \"ref\": \"$DEFAULT_BRANCH\",
                \"inputs\": {
                  \"version\": \"$VERSION\",
                  \"chain_id\": \"$CHAIN_ID\"
                }
              }")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_CODE" -eq 204 ]; then
              echo "âœ… Successfully triggered update-registry for $VERSION"
            else
              echo "::warning::Failed to trigger update-registry for $VERSION (HTTP $HTTP_CODE)"
            fi
            
            # Small delay to avoid rate limiting
            sleep 2
          }
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Registry Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TRIGGERED_COUNT=0
          
          # Trigger for each successful deployment
          if [ "${{ steps.parse_targets.outputs.deploy_1_3_0 }}" == "true" ]; then
            trigger_update "v1.3.0-canonical" "${{ steps.deploy_1_3_0.outcome }}"
            if [ "${{ steps.deploy_1_3_0.outcome }}" == "success" ]; then
              echo "- âœ… Triggered registry update for **v1.3.0-canonical**" >> $GITHUB_STEP_SUMMARY
              TRIGGERED_COUNT=$((TRIGGERED_COUNT + 1))
            fi
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_3_0_155 }}" == "true" ]; then
            trigger_update "v1.3.0-eip155" "${{ steps.deploy_1_3_0_155.outcome }}"
            if [ "${{ steps.deploy_1_3_0_155.outcome }}" == "success" ]; then
              echo "- âœ… Triggered registry update for **v1.3.0-eip155**" >> $GITHUB_STEP_SUMMARY
              TRIGGERED_COUNT=$((TRIGGERED_COUNT + 1))
            fi
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_4_1 }}" == "true" ]; then
            trigger_update "v1.4.1" "${{ steps.deploy_1_4_1.outcome }}"
            if [ "${{ steps.deploy_1_4_1.outcome }}" == "success" ]; then
              echo "- âœ… Triggered registry update for **v1.4.1**" >> $GITHUB_STEP_SUMMARY
              TRIGGERED_COUNT=$((TRIGGERED_COUNT + 1))
            fi
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_1_5_0 }}" == "true" ]; then
            trigger_update "v1.5.0" "${{ steps.deploy_1_5_0.outcome }}"
            if [ "${{ steps.deploy_1_5_0.outcome }}" == "success" ]; then
              echo "- âœ… Triggered registry update for **v1.5.0**" >> $GITHUB_STEP_SUMMARY
              TRIGGERED_COUNT=$((TRIGGERED_COUNT + 1))
            fi
          fi
          
          # Note: Modules are skipped as the registry only supports Safe Smart Account versions
          if [ "${{ steps.parse_targets.outputs.deploy_modules }}" == "true" ] && [ "${{ steps.deploy_modules.outcome }}" == "success" ]; then
            echo "- â­ï¸ Skipped **modules** (registry only supports Smart Account versions)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Note: Tokens are not part of the safe-deployments registry
          if [ "${{ steps.parse_targets.outputs.deploy_erc20 }}" == "true" ] && [ "${{ steps.deploy_erc20.outcome }}" == "success" ]; then
            echo "- â­ï¸ Skipped **ERC20** (not part of Safe deployments registry)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.parse_targets.outputs.deploy_erc721 }}" == "true" ] && [ "${{ steps.deploy_erc721.outcome }}" == "success" ]; then
            echo "- â­ï¸ Skipped **ERC721** (not part of Safe deployments registry)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $TRIGGERED_COUNT -gt 0 ]; then
            echo "**Total**: $TRIGGERED_COUNT registry update(s) triggered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check progress: https://github.com/$REPO/actions" >> $GITHUB_STEP_SUMMARY
          else
            echo "**No registry updates triggered** (no successful Smart Account deployments)" >> $GITHUB_STEP_SUMMARY
          fi

