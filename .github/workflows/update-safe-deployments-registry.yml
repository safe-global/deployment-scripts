name: Update Safe Deployments Registry

# This workflow automatically triggers the update-registry workflow in safe-deployments-1
# repository after a successful deployment in this repository.
#
# Required Secret:
#   SAFE_DEPLOYMENTS_1_TOKEN - A GitHub Personal Access Token (PAT) with workflow permissions
#   to trigger workflows in the Fbartoli/safe-deployments repository.
#
# Setup:
#   1. Create a GitHub PAT with 'workflow' scope
#   2. Add it as a secret named SAFE_DEPLOYMENTS_1_TOKEN in this repository's settings
#   3. The workflow will automatically run after successful deployments

on:
  workflow_run:
    workflows:
      - "Deploy Safe 1.3.0 Canonical Contracts"
      - "Deploy Safe 1.3.0 EIP-155 Contracts"
      - "Deploy Safe 1.4.1 Contracts"
      - "Deploy Safe 1.5.0 Contracts"
      - "Deploy Safe Modules"
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Safe version with deployment type'
        required: true
        type: choice
        options:
          - v1.3.0-canonical
          - v1.3.0-eip155
          - v1.4.1
          - v1.5.0
      chain_id:
        description: 'Chain ID to add (e.g., 11155111)'
        required: true
        type: string
      network_name:
        description: 'Network name (optional, for logging)'
        required: false
        type: string
        default: 'custom'
      workflow_run_id:
        description: 'Workflow run ID to download artifacts from (optional, for manual trigger)'
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  update-registry:
    name: Update Safe Deployments Registry
    runs-on: ubuntu-latest
    # Allow manual trigger or successful workflow_run
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends jq

      - name: Determine workflow type and artifact name
        id: workflow-info
        run: |
          # Handle manual trigger (workflow_dispatch) vs automatic trigger (workflow_run)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use inputs
            VERSION="${{ github.event.inputs.version }}"
            CHAIN_ID="${{ github.event.inputs.chain_id }}"
            NETWORK_NAME="${{ github.event.inputs.network_name || 'custom' }}"
            WORKFLOW_RUN_ID="${{ github.event.inputs.workflow_run_id }}"
            
            echo "Manual trigger detected"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "chain_id=$CHAIN_ID" >> $GITHUB_OUTPUT
            echo "network=$NETWORK_NAME" >> $GITHUB_OUTPUT
            echo "is_module=false" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
            
            # Determine artifact name based on version
            case "$VERSION" in
              "v1.3.0-canonical")
                echo "artifact_name=deployment-summary" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                ;;
              "v1.4.1")
                echo "artifact_name=deployment-summary-1.4.1" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                ;;
              "v1.5.0")
                echo "artifact_name=deployment-summary-1.5.0" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "artifact_name=deployment-summary" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                ;;
            esac
            
            # Store workflow_run_id if provided
            if [ -n "$WORKFLOW_RUN_ID" ]; then
              echo "workflow_run_id=$WORKFLOW_RUN_ID" >> $GITHUB_OUTPUT
            fi
          else
            # Automatic trigger - determine from workflow_run
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
            echo "is_manual=false" >> $GITHUB_OUTPUT
            
            # Determine artifact name based on workflow
            # Note: Artifact names must match those created in the deployment workflows
            case "$WORKFLOW_NAME" in
            "Deploy Safe 1.3.0 Canonical Contracts")
              echo "artifact_name=deployment-summary" >> $GITHUB_OUTPUT
              echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
              echo "version=v1.3.0-canonical" >> $GITHUB_OUTPUT
              echo "is_module=false" >> $GITHUB_OUTPUT
              ;;
            "Deploy Safe 1.3.0 EIP-155 Contracts")
              echo "artifact_name=deployment-summary-1.3.0-155" >> $GITHUB_OUTPUT
              echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
              echo "version=v1.3.0-eip155" >> $GITHUB_OUTPUT
              echo "is_module=false" >> $GITHUB_OUTPUT
              ;;
            "Deploy Safe 1.4.1 Contracts")
                echo "artifact_name=deployment-summary-1.4.1" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                echo "version=v1.4.1" >> $GITHUB_OUTPUT
                echo "is_module=false" >> $GITHUB_OUTPUT
                ;;
              "Deploy Safe 1.5.0 Contracts")
                echo "artifact_name=deployment-summary-1.5.0" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                echo "version=v1.5.0" >> $GITHUB_OUTPUT
                echo "is_module=false" >> $GITHUB_OUTPUT
                ;;
              "Deploy Safe Modules")
                echo "artifact_name=deployment-summary-modules" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-modules-summary-*-latest.json" >> $GITHUB_OUTPUT
                echo "version=modules" >> $GITHUB_OUTPUT
                echo "is_module=true" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "artifact_name=deployment-summary" >> $GITHUB_OUTPUT
                echo "summary_file_pattern=github-actions-summary-*-latest.json" >> $GITHUB_OUTPUT
                echo "version=unknown" >> $GITHUB_OUTPUT
                echo "is_module=false" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Download deployment summary artifact
        id: download-artifact
        if: steps.workflow-info.outputs.is_manual != 'true' || steps.workflow-info.outputs.workflow_run_id != ''
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ${{ steps.workflow-info.outputs.artifact_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.workflow-info.outputs.workflow_run_id || github.event.workflow_run.id }}
          path: ./deployment-artifacts

      - name: Extract deployment information
        id: extract-info
        run: |
          # Handle manual trigger vs automatic trigger
          if [ "${{ steps.workflow-info.outputs.is_manual }}" = "true" ]; then
            # Manual trigger - use inputs directly
            CHAIN_ID="${{ github.event.inputs.chain_id }}"
            NETWORK="${{ github.event.inputs.network_name || 'custom' }}"
            VERSION="${{ github.event.inputs.version }}"
            
            echo "Using manual inputs:"
            echo "  Version: $VERSION"
            echo "  Chain ID: $CHAIN_ID"
            echo "  Network: $NETWORK"
            
            echo "chain_id=$CHAIN_ID" >> $GITHUB_OUTPUT
            echo "network=$NETWORK" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "total_contracts=0" >> $GITHUB_OUTPUT
            echo "successful=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            
            # Display summary
            echo "## Deployment Information (Manual Trigger)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger**: Manual (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
            echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Network**: $NETWORK" >> $GITHUB_STEP_SUMMARY
            echo "- **Chain ID**: $CHAIN_ID" >> $GITHUB_STEP_SUMMARY
          else
            # Automatic trigger - extract from deployment summary file
            SUMMARY_FILE=$(find ./deployment-artifacts -name "${{ steps.workflow-info.outputs.summary_file_pattern }}" -type f | head -1)
            
            if [ -z "$SUMMARY_FILE" ]; then
              # Try alternative locations
              SUMMARY_FILE=$(find ./deployment-artifacts -name "*-latest.json" -type f | head -1)
            fi
            
            if [ -z "$SUMMARY_FILE" ] || [ ! -f "$SUMMARY_FILE" ]; then
              echo "::error::Deployment summary file not found"
              echo "Searched for: ${{ steps.workflow-info.outputs.summary_file_pattern }}"
              echo "Files in deployment-artifacts:"
              find ./deployment-artifacts -type f || echo "No files found"
              exit 1
            fi
            
            echo "Found summary file: $SUMMARY_FILE"
            echo "summary_file=$SUMMARY_FILE" >> $GITHUB_OUTPUT
            
            # Extract chain ID
            CHAIN_ID=$(jq -r '.chainId // empty' "$SUMMARY_FILE")
            if [ -z "$CHAIN_ID" ] || [ "$CHAIN_ID" = "null" ]; then
              echo "::error::Chain ID not found in deployment summary"
              exit 1
            fi
            
            echo "chain_id=$CHAIN_ID" >> $GITHUB_OUTPUT
            
            # Extract network name
            NETWORK=$(jq -r '.network // "unknown"' "$SUMMARY_FILE")
            echo "network=$NETWORK" >> $GITHUB_OUTPUT
            
            # Extract version if not already set
            if [ -z "${{ steps.workflow-info.outputs.version }}" ]; then
              VERSION=$(jq -r '.version // "unknown"' "$SUMMARY_FILE")
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            else
              echo "version=${{ steps.workflow-info.outputs.version }}" >> $GITHUB_OUTPUT
            fi
            
            # Extract deployment stats
            TOTAL=$(jq -r '.totalContracts // 0' "$SUMMARY_FILE")
            SUCCESSFUL=$(jq -r '.successful // 0' "$SUMMARY_FILE")
            FAILED=$(jq -r '.failed // 0' "$SUMMARY_FILE")
            
            echo "total_contracts=$TOTAL" >> $GITHUB_OUTPUT
            echo "successful=$SUCCESSFUL" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            
            # Display summary
            echo "## Deployment Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Workflow**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Version**: ${{ steps.workflow-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Network**: $NETWORK" >> $GITHUB_STEP_SUMMARY
            echo "- **Chain ID**: $CHAIN_ID" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Contracts**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Successful**: $SUCCESSFUL" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: $FAILED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip if modules deployment
        if: steps.workflow-info.outputs.is_module == 'true'
        run: |
          echo "::notice::Modules deployment detected. The update-registry workflow in safe-deployments-1 only supports Safe Smart Account versions (v1.3.0-canonical, v1.3.0-eip155, v1.4.1, v1.5.0), not modules."
          echo "Skipping registry update for modules deployment."
          exit 0

      - name: Skip if version not supported
        if: steps.extract-info.outputs.version == 'unknown'
        run: |
          echo "::warning::Unknown version detected. Skipping registry update."
          exit 0

      - name: Trigger update-registry workflow in safe-deployments-1
        if: steps.workflow-info.outputs.is_module == 'false' && steps.extract-info.outputs.version != 'unknown'
        env:
          GITHUB_TOKEN: ${{ secrets.SAFE_DEPLOYMENTS_1_TOKEN }}
        run: |
          # Use GitHub API to trigger the workflow_dispatch event
          REPO="Fbartoli/safe-deployments"
          WORKFLOW_FILE="update-registry.yml"
          
          echo "Triggering workflow: $WORKFLOW_FILE in $REPO"
          echo "Version: ${{ steps.extract-info.outputs.version }}"
          echo "Chain ID: ${{ steps.extract-info.outputs.chain_id }}"
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "::error::SAFE_DEPLOYMENTS_1_TOKEN secret is not set. Please configure a GitHub Personal Access Token with workflow permissions."
            exit 1
          fi
          
          # Test token permissions by checking repository access
          echo "Testing token permissions..."
          TEST_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO")
          
          TEST_HTTP_CODE=$(echo "$TEST_RESPONSE" | tail -n1)
          TEST_BODY=$(echo "$TEST_RESPONSE" | head -n-1)
          
          if [ "$TEST_HTTP_CODE" -ne 200 ]; then
            echo "::error::Token cannot access repository. HTTP $TEST_HTTP_CODE"
            echo "Response: $TEST_BODY"
            echo ""
            echo "Troubleshooting:"
            echo "1. Make sure your PAT has 'workflow' scope enabled"
            echo "2. Make sure your PAT has 'repo' scope enabled (required for triggering workflows)"
            echo "3. Verify the token has access to the repository: $REPO"
            echo "4. Check if the repository is private and the token has access"
            exit 1
          fi
          
          echo "✅ Token has repository access"
          
          # Get workflow ID
          WORKFLOW_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE")
          
          HTTP_CODE=$(echo "$WORKFLOW_RESPONSE" | tail -n1)
          WORKFLOW_BODY=$(echo "$WORKFLOW_RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Failed to get workflow. HTTP $HTTP_CODE"
            echo "Response: $WORKFLOW_BODY"
            exit 1
          fi
          
          WORKFLOW_ID=$(echo "$WORKFLOW_BODY" | jq -r '.id')
          
          if [ "$WORKFLOW_ID" = "null" ] || [ -z "$WORKFLOW_ID" ]; then
            echo "::error::Failed to get workflow ID from response"
            echo "Response: $WORKFLOW_BODY"
            exit 1
          fi
          
          echo "Workflow ID: $WORKFLOW_ID"
          
          # Get default branch from repository
          REPO_INFO=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO")
          
          DEFAULT_BRANCH=$(echo "$REPO_INFO" | jq -r '.default_branch // "main"')
          echo "Default branch: $DEFAULT_BRANCH"
          
          # Trigger workflow_dispatch
          VERSION="${{ steps.extract-info.outputs.version }}"
          CHAIN_ID="${{ steps.extract-info.outputs.chain_id }}"
          
          DISPATCH_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/dispatches" \
            -d "{
              \"ref\": \"$DEFAULT_BRANCH\",
              \"inputs\": {
                \"version\": \"$VERSION\",
                \"chain_id\": \"$CHAIN_ID\"
              }
            }")
          
          DISPATCH_HTTP_CODE=$(echo "$DISPATCH_RESPONSE" | tail -n1)
          DISPATCH_BODY=$(echo "$DISPATCH_RESPONSE" | head -n-1)
          
          if [ "$DISPATCH_HTTP_CODE" -eq 204 ]; then
            echo "::notice::Successfully triggered update-registry workflow in $REPO"
            echo "Workflow URL: https://github.com/$REPO/actions"
            echo "workflow_triggered=true" >> $GITHUB_OUTPUT
            echo "workflow_url=https://github.com/$REPO/actions" >> $GITHUB_OUTPUT
          else
            echo "::error::Failed to trigger workflow. HTTP $DISPATCH_HTTP_CODE"
            echo "Response: $DISPATCH_BODY"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Verify your PAT has 'workflow' scope:"
            echo "   - Go to GitHub Settings → Developer settings → Personal access tokens"
            echo "   - Edit your token and ensure 'workflow' scope is checked"
            echo ""
            echo "2. Verify your PAT has 'repo' scope (required for triggering workflows):"
            echo "   - The 'repo' scope is needed even for public repositories to trigger workflows"
            echo ""
            echo "3. Check if the workflow file exists:"
            echo "   - Verify .github/workflows/update-registry.yml exists in $REPO"
            echo ""
            echo "4. Verify the workflow is enabled:"
            echo "   - Go to $REPO → Settings → Actions → General"
            echo "   - Ensure 'Allow all actions and reusable workflows' is enabled"
            echo ""
            echo "5. For fine-grained tokens, ensure:"
            echo "   - Repository access includes $REPO"
            echo "   - Permissions → Actions is set to 'Read and write'"
            exit 1
          fi

      - name: Display summary
        if: always()
        run: |
          echo "## Update Registry Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.workflow-info.outputs.is_module }}" = "true" ]; then
            echo "⚠️ **Modules deployment detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The update-registry workflow in safe-deployments-1 only supports Safe Smart Account versions, not modules." >> $GITHUB_STEP_SUMMARY
            echo "Skipping registry update." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.extract-info.outputs.version }}" = "unknown" ]; then
            echo "⚠️ **Unknown version detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not determine version. Skipping registry update." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Successfully triggered update-registry workflow**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository**: Fbartoli/safe-deployments" >> $GITHUB_STEP_SUMMARY
            echo "- **Version**: ${{ steps.extract-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Chain ID**: ${{ steps.extract-info.outputs.chain_id }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Network**: ${{ steps.extract-info.outputs.network }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow run: https://github.com/Fbartoli/safe-deployments/actions" >> $GITHUB_STEP_SUMMARY
          fi

